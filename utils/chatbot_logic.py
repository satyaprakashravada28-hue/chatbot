import pandas as pd
from transformers import pipeline
from langdetect import detect
import random

# Load dataset
try:
    df = pd.read_csv("agriassist_multilang_greeting.csv")
except Exception as e:
    print("тЭМ Error loading dataset:", e)
    df = pd.DataFrame(columns=["Name", "Use (English)", "Use (Telugu)", "Use (Hindi)", "Category"])

# Try to load QA pipeline
try:
    qa_pipeline = pipeline("question-answering", model="distilbert-base-uncased-distilled-squad")
except Exception as e:
    print("тЭМ Error loading transformers pipeline:", e)
    qa_pipeline = None

# Short replies dictionary (multi-language support)
shortcuts = {
    "en": {
        "hi": "Hello! I'm AgriAssist тАФ your farming buddy.",
        "joke": "ЁЯШВ Why did the scarecrow win an award? Because he was outstanding in his field!"
    },
    "kn": {
        "р▓ир▓ор▓╕р│Нр▓Хр▓╛р▓░.": "р▓╣р▓▓р│Л! р▓ир▓╛р▓ир│Б р▓Ер▓Чр│Нр▓░р▓┐р▓Ер▓╕р▓┐р▓╕р│Нр▓Яр│Н тАФ р▓ир▓┐р▓ор│Нр▓о р▓Хр│Гр▓╖р▓┐ р▓Чр│Жр▓│р│Жр▓п.",
        "joke": "ЁЯШВ р▓нр│Вр▓др▓ж р▓Чр│Бр▓бр│Нр▓бр▓Чр│Ж р▓мр▓╣р│Бр▓ор▓╛р▓и р▓пр▓╛р▓Хр│Ж р▓╕р▓┐р▓Хр│Нр▓Хр▓┐р▓др│Б? р▓Пр▓Хр│Жр▓Вр▓жр▓░р│Ж р▓Ер▓╡р▓ир│Б р▓др▓ир│Нр▓и р▓╣р│Кр▓▓р▓жр▓▓р│Нр▓▓р▓┐ р▓Ер▓╕р▓╛р▓зр▓╛р▓░р▓гр▓ир▓╛р▓Чр▓┐р▓жр│Нр▓ж!"
    },
    "ml": {
        "р┤ир┤ор┤╕р╡Нр┤Хр┤╛р┤░р┤В.": "р┤╣р┤▓р╡Л! р┤Юр┤╛р┤ир┤╛р┤гр╡Н р┤Ер┤Чр╡Нр┤░р┤┐р┤Ер┤╕р┤┐р┤╕р╡Нр┤▒р╡Нр┤▒р╡Н тАФ р┤ир┤┐р┤Щр╡Нр┤Щр┤│р╡Бр┤Яр╡Ж р┤Хр╡Гр┤╖р┤┐р┤╕р╡Нр┤ер┤▓р┤В р┤Хр╡Вр┤Яр╡Нр┤Яр╡Бр┤Хр┤╛р┤░р┤ир╡НтАН.",
        "joke": "ЁЯШВ р┤Хр┤╛р┤Хр╡Нр┤Хр┤пр╡Ж р┤нр┤пр┤кр╡Нр┤кр╡Жр┤Яр╡Бр┤др╡Нр┤др╡Бр┤ир╡Нр┤и р┤ор╡Лр┤бр┤▓р┤┐р┤ир╡Н р┤Ер┤╡р┤╛р╡╝р┤бр╡Н р┤▓р┤нр┤┐р┤Ър╡Нр┤Ър┤др╡Н р┤Ор┤ир╡Нр┤др╡Бр┤Хр╡Кр┤гр╡Нр┤Яр╡Н? р┤Хр┤╛р┤░р┤гр┤В р┤Ер┤др╡Н р┤др┤ир╡Нр┤▒р╡Ж р┤╡р┤пр┤▓р┤┐р╡╜ р┤ор┤┐р┤Хр┤Ър╡Нр┤Ър┤др┤╛р┤пр┤┐р┤░р╡Бр┤ир╡Нр┤ир╡Б!"
    },
    "pa": {
        "hi": "ри╣рйИри▓рйЛ! риорйИриВ риЕрйИриЧри░рйАриЕри╕ри┐ри╕риЯ ри╣ри╛риВ тАФ ридрйБри╣ри╛рибри╛ риЦрйЗридрйАримри╛рйЬрйА ри╕ри╛риерйА.",
        "joke": "ЁЯШВ рибри░ри╛риЙригрйА рикридри▓ риирйВрй░ риЗриири╛рио риХри┐риЙриВ риори┐ри▓ри┐риЖ? риХри┐риЙриВриХри┐ риЙри╣ риЖрикригрйЗ риЦрйЗрид ри╡ри┐рй▒риЪ ри╕ри╝ри╛риирижри╛ри░ ри╕рйА!"
    },
    "gu": {
        "hi": "рк╣рлЗрк▓рлЛ! рк╣рлБркВ ркПркЧрлНрк░рлАркЕрк╕рк┐рк╕рлНркЯ ркЫрлБркВ тАФ ркдркорк╛рк░рлЛ ркЦрлЗркдрлА рк╕рк╣рк╛ркпркХ.",
        "joke": "ЁЯШВ ркнрлВркдрк┐ркпрк╛ ркХрк╛ркХркбрк╛ркирлЗ ркПрк╡рлЛрк░рлНркб рк╢рк╛ ркорк╛ркЯрлЗ ркорк│рлНркпрлЛ? ркХрк╛рк░ркг ркХрлЗ ркдрлЗ рккрлЛркдрк╛ркирлА ркЦрлЗркдрк░ркорк╛ркВ ркЙркдрлНркХрлГрк╖рлНркЯ рк╣ркдрлЛ!"
    },
    "or": {
        "hi": "рмирморм╕рнНрмХрм╛рм░! рморнБрмБ рмЕрмЧрнНрм░рм┐рмЕрм╕рм┐рм╖рнНрмЯ тАФ рмЖрмкрмгрмЩрнНрмХрм░ рмХрнГрм╖рм┐ рм╕рм╣рмпрнЛрмЧрнАред",
        "joke": "ЁЯШВ рмХрм╛рмЙрмХрнБ рмнрнЯ рмкрмХрм╛рмЙрмерм┐рммрм╛ рмЭрнБрм▓рм╛рмХрнБ рмкрнБрм░рм╕рнНрмХрм╛рм░ рморм┐рм│рм┐рм▓рм╛ рмХрм╛рм╣рм┐рмБрмХрм┐? рмХрм╛рм░рмг рм╕рнЗ рмдрм╛рмЩрнНрмХрм░ рмЦрнЗрмдрм░рнЗ рмЕрм╕рм╛рмзрм╛рм░рмг рмерм┐рм▓рнЗ!"
    },
    "bn": {
        "hi": "рж╣рзНржпрж╛рж▓рзЛ! ржЖржорж┐ ржПржЧрзНрж░рж┐ржЕрзНржпрж╛рж╕рж┐рж╕рзНржЯ тАФ ржЖржкржирж╛рж░ ржХрзГрж╖рж┐ ржмржирзНржзрзБред",
        "joke": "ЁЯШВ ржХрж╛ржХржнрзАрждрж┐рж░ ржорзВрж░рзНрждрж┐ржХрзЗ ржкрзБрж░рж╕рзНржХрж╛рж░ ржжрзЗржУржпрж╝рж╛ рж╣ржпрж╝рзЗржЫрж┐рж▓ ржХрзЗржи? ржХрж╛рж░ржг рж╕рзЗ рждрж╛рж░ ржЦрзЗрждрзЗ ржЕрж╕рж╛ржзрж╛рж░ржг ржЫрж┐рж▓!"
    },
    "as": {
        "hi": "ржиржорж╕рзНржХрж╛рз░! ржоржЗ ржПржЧрзНрз░рж┐ржЕржЫрж┐рж╖рзНржЯ тАФ ржЖржкрзЛржирж╛рз░ ржЦрзЗрждрж┐ рж╕рж╣рж╛ржпрж╝ржХред",
        "joke": "ЁЯШВ ржХрзЗржБржЪрж╛ ржорж╛ржирзБрж╣ржЬржиржХ ржкрзБрз░рж╕рзНржХрж╛рз░ ржХрж┐ржпрж╝ ржжрж┐ржпрж╝рж╛ рж╣рзИржЫрж┐рж▓? ржХрж╛рз░ржг рждрзЗржУржБ ржирж┐ржЬрз░ ржЦрзЗрждрж┐ржд ржЕрждрж┐ ржЙрзОржХрзГрж╖рзНржЯ ржЖржЫрж┐рж▓!"
    },
    "te": {
        "р░╣р░╛р░пр▒Н.": "ЁЯСЛ р░╣р░╛р░пр▒Н р░░р▒Ир░др▒В! р░Ор░▓р░╛ р░Йр░ир▒Нр░ир░╛р░╡р▒Б?",
        "р░╣р░▓р▒Л.": "ЁЯМ▒ р░╣р░▓р▒Л! р░ир▒Зр░ир▒Б р░ир▒А р░╡р▒Нр░пр░╡р░╕р░╛р░п р░╕р▒Нр░ир▒Зр░╣р░┐р░др▒Бр░бр▒Б AgriAssist.",
        'р░╣р▒Жр░▓р▒Н.':"ЁЯМ▒ р░╣р░▓р▒Л! р░ир▒Зр░ир▒Б р░ир▒А р░╡р▒Нр░пр░╡р░╕р░╛р░п р░╕р▒Нр░ир▒Зр░╣р░┐р░др▒Бр░бр▒Б AgriAssist.",
        "р░Пр░ор░ир▒Нр░ир░╛р░╡р▒Б.": "ЁЯШГ р░ир▒Бр░╡р▒Нр░╡р▒З р░Ър▒Жр░кр▒Нр░кр▒Б р░░р▒Ир░др▒В, р░ир▒Ар░Хр▒Б р░Пр░В р░Хр░╛р░╡р░╛р░▓р░┐?",
        "р░Ор░В р░░р░╛ р░мр░╛р░мр▒Б.": "ЁЯШВ р░ир▒Зр░ир▒З AgriAssist р░мр░╛р░мр▒Б, р░ир▒Ар░Хр▒Б р░╕р░╣р░╛р░пр░В р░Ър▒Зр░пр░бр░╛р░ир░┐р░Хр░┐ р░╡р░Ър▒Нр░Ър░╛р░ир▒Б!",
        "р░Ьр▒Лр░Хр▒Н р░Ър▒Жр░кр▒Нр░кр▒Б.": "ЁЯШВ р░У р░░р▒Ир░др▒Б р░Ор░Вр░жр▒Бр░Хр▒Б р░Жр░ир░Вр░жр░Вр░Чр░╛ р░Йр░ир▒Нр░ир░╛р░бр▒Б? р░Ор░Вр░жр▒Бр░Хр░Вр░Яр▒З р░кр░Вр░Я р░мр░╛р░Чр▒Бр░Вр░жр░┐!",
        "р░ир▒Бр░╡р▒Нр░╡р▒Жр░╡р░░р▒Б.": "ЁЯдЦ р░ир▒Зр░ир▒Б AgriAssist тАФ р░ир▒А р░бр░┐р░Ьр░┐р░Яр░▓р▒Н р░╡р▒Нр░пр░╡р░╕р░╛р░п р░╕р▒Нр░ир▒Зр░╣р░┐р░др▒Бр░бр▒Б.",
        "р░Ор░▓р░╛ р░Йр░ир▒Нр░ир░╛р░╡р▒Б?": "ЁЯШЗ р░мр░╛р░Чр▒Бр░ир▒Нр░ир░╛р░ир▒Б! р░░р▒Ир░др▒Бр░▓р░Хр▒Б р░╕р░╣р░╛р░пр░В р░Ър▒Зр░пр░бр░В р░ир░╛ р░Жр░ир░Вр░жр░В.",
        "р░╡р░╛р░др░╛р░╡р░░р░гр░В.": "ЁЯМжя╕П р░╡р░╛р░др░╛р░╡р░░р░г р░╕р░ор░╛р░Ър░╛р░░р░В р░Хр░╛р░╡р░╛р░▓р░╛? р░Ер░бр▒Бр░Чр▒Б.",
        "р░кр░Вр░Я.": "ЁЯМ╛ р░П р░кр░Вр░Я р░Чр▒Бр░░р░┐р░Вр░Ър░┐ р░др▒Жр░▓р▒Бр░╕р▒Бр░Хр▒Лр░╡р░╛р░▓р░┐?",
        "р░зр░ир▒Нр░пр░╡р░╛р░жр░╛р░▓р▒Б.": "ЁЯЩП р░зр░ир▒Нр░пр░╡р░╛р░жр░╛р░▓р▒Б! р░Ор░кр▒Нр░кр▒Бр░бр▒В р░╕р░╣р░╛р░пр░В р░Ър▒Зр░╕р▒Нр░др░╛р░ир▒Б."
    },
    "hi": {
        "рдирдорд╕реНрддреЗред": "ЁЯСЛ рдирдорд╕реНрддреЗ рдХрд┐рд╕рд╛рди! рдореИрдВ AgriAssist рд╣реВрдБ тАФ рдЖрдкрдХрд╛ рдЦреЗрддреА рд╕рд╛рдереАред",
        "рдирдорд╕реНрддреЗред": "ЁЯСЛ рдирдорд╕реНрддреЗ рдХрд┐рд╕рд╛рди! рдореИрдВ AgriAssist рд╣реВрдБ тАФ рдЖрдкрдХрд╛ рдЦреЗрддреА рд╕рд╛рдереАред",
        "рдЬреЛрдХ": "ЁЯШВ рдбрд░рд╛рд╡рдирд╛ рдкреБрддрд▓рд╛ рдЗрдирд╛рдо рдХреНрдпреЛрдВ рдЬреАрддрд╛? рдХреНрдпреЛрдВрдХрд┐ рд╡рд╣ рдЦреЗрдд рдореЗрдВ рд╕рдмрд╕реЗ рд╢рд╛рдирджрд╛рд░ рдЦрдбрд╝рд╛ рдерд╛!",
        "рдЖрдк рдХреМрди рд╣реЛ?": "ЁЯдЦ рдореИрдВ AgriAssist рд╣реВрдБ тАФ рдЖрдкрдХрд╛ рдЦреЗрддреА рд╕рд╣рд╛рдпрдХред",
        "рдХреИрд╕реЗ рд╣реЛ?": "ЁЯШЗ рдореИрдВ рдЕрдЪреНрдЫрд╛ рд╣реВрдБ! рдХрд┐рд╕рд╛рдиреЛрдВ рдХреА рдорджрдж рдХрд░рдирд╛ рд╣реА рдЦреБрд╢реА рд╣реИред",
        "рдореМрд╕рдоред": "ЁЯМжя╕П рдореМрд╕рдо рдХреА рдЬрд╛рдирдХрд╛рд░реА рдЪрд╛рд╣рд┐рдП?",
        "рдлрд╕рд▓ред": "ЁЯМ╛ рдХрд┐рд╕ рдлрд╕рд▓ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдирд╛ рд╣реИ?",
        "рдзрдиреНрдпрд╡рд╛рджред": "ЁЯЩП рдзрдиреНрдпрд╡рд╛рдж! рд╣рдореЗрд╢рд╛ рдорджрдж рдХрд░реВрдВрдЧрд╛ред"
    }
}

# === MAIN FUNCTION ===
def generate_chatbot_response(user_input):
    try:
        if not user_input.strip():
            return "Please ask something related to farming or crops."

        if qa_pipeline is None:
            return "тЪая╕П Chatbot model not loaded. Please check the backend."

        cleaned_input = user_input.strip().lower()

        # --- Detect language (default English if fail)
        try:
            lang_detected = detect(user_input)
        except:
            lang_detected = "en"

        if lang_detected.startswith("te"):
            lang = "te"
            response_column = "Use (Telugu)"
        elif lang_detected.startswith("kn"):
            lang = "kn"
        elif lang_detected.startswith("hi"):
            lang = "hi"
            response_column = "Use (Kannada)"
        elif lang_detected.startswith("ml"):
            lang = "ml"
            response_column = "Use (Malayalam)"
        elif lang_detected.startswith("pa"):
            lang = "pa"
            response_column = "Use (Punjabi)"
        elif lang_detected.startswith("gu"):
            lang = "gu"
            response_column = "Use (Gujarati)"
        elif lang_detected.startswith("or"):
            lang = "or"
            response_column = "Use (Odia)"
        elif lang_detected.startswith("bn"):
            lang = "bn"
            response_column = "Use (Bengali)"
        elif lang_detected.startswith("as"):
            lang = "as"
            response_column = "Use (Assamese)"
        else:
            lang = "en"
            response_column = "Use (English)"

        # --- 1. Shortcuts (multi-language)
        if cleaned_input in shortcuts.get(lang, {}):
            return shortcuts[lang][cleaned_input]

        # --- 2. Exact match on 'Name'
        exact = df[df["Name"].str.lower() == cleaned_input]
        if not exact.empty:
            return exact.iloc[0].get(response_column, exact.iloc[0]["Use (English)"])

        # --- 3. Partial match on 'Name'
        partial = df[df["Name"].str.lower().str.contains(cleaned_input)]
        if not partial.empty:
            return partial.iloc[0].get(response_column, partial.iloc[0]["Use (English)"])

        # --- 4. Category match
        category_match = df[df["Category"].str.lower() == cleaned_input]
        if not category_match.empty:
            return random.choice(category_match[response_column].dropna().tolist())

        # --- 5. QA Fallback
        full_context = "\n".join([f"{row['Name']}: {row.get(response_column, row.get('Use (English)', ''))}"
                                  for _, row in df.iterrows()])

        result = qa_pipeline({
            "context": full_context,
            "question": user_input
        })

        answer = result.get("answer", "")
        score = result.get("score", 0)

        if score > 0.3 and len(answer) > 3:
            return answer.strip()
        else:
            return {
                "en": "ЁЯдФ I'm not sure. Try asking about crops, soil, fertilizers, irrigation, or weather.",
                "te": "ЁЯдФ р░ир░╛р░Хр▒Б р░Цр░Ър▒Нр░Ър░┐р░др░Вр░Чр░╛ р░др▒Жр░▓р░┐р░пр░жр▒Б. р░кр░Вр░Яр░▓р▒Б, р░Ор░░р▒Бр░╡р▒Бр░▓р▒Б, р░ир▒Ар░Яр░┐ р░кр░╛р░░р▒Бр░жр░▓ р░▓р▒Зр░жр░╛ р░╡р░╛р░др░╛р░╡р░░р░гр░В р░Чр▒Бр░░р░┐р░Вр░Ър░┐ р░Ер░бр░Чр░Вр░бр░┐.",
                "hi": "ЁЯдФ рдореБрдЭреЗ рдпрдХреАрди рдирд╣реАрдВ рд╣реИред рдлрд╕рд▓, рдЙрд░реНрд╡рд░рдХ, рд╕рд┐рдВрдЪрд╛рдИ рдпрд╛ рдореМрд╕рдо рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкреВрдЫреЗрдВред",
                "kn": " р▓ир▓ир▓Чр│Ж р▓Цр▓Ър▓┐р▓др▓╡р▓┐р▓▓р│Нр▓▓. р▓жр▓пр▓╡р▓┐р▓Яр│Нр▓Яр│Б р▓мр│Жр▓│р│Жр▓Чр▓│р│Б, р▓░р▓╕р▓Чр│Кр▓мр│Нр▓мр▓░р│Жр▓Чр▓│р│Б р▓Ер▓ер▓╡р▓╛ р▓╣р▓╡р▓╛р▓ор▓╛р▓ир▓ж р▓мр▓Чр│Нр▓Чр│Ж р▓Хр│Зр▓│р▓┐.",
                "ml": " р┤Ор┤ир┤┐р┤Хр╡Нр┤Хр╡Н р┤Йр┤▒р┤кр╡Нр┤кр┤┐р┤▓р╡Нр┤▓. р┤╡р┤┐р┤│р┤Хр╡╛, р┤╡р┤│р┤Щр╡Нр┤Щр╡╛, р┤Хр┤╛р┤▓р┤╛р┤╡р┤╕р╡Нр┤е р┤Ор┤ир╡Нр┤ир┤┐р┤╡р┤пр╡Жр┤Хр╡Нр┤Хр╡Бр┤▒р┤┐р┤Ър╡Нр┤Ър╡Н р┤Ър╡Лр┤жр┤┐р┤Хр╡Нр┤Хр╡В.",
                "pa": " риорйИриирйВрй░ рикридри╛ риири╣рйАриВред рилри╕ри▓ри╛риВ, риЦри╛рижри╛риВ риЬри╛риВ риорйМри╕рио римри╛ри░рйЗ рикрйБрй▒риЫрйЛ риЬрйАред",
                "gu": " ркоркирлЗ ркЦрк╛ркдрк░рлА ркиркерлА. ркХрлГрккрк╛ ркХрк░рлАркирлЗ рккрк╛ркХрлЛ, ркЦрк╛ркдрк░рлЛ, рк╕рк┐ркВркЪрк╛ркИ ркЕркерк╡рк╛ рк╣рк╡рк╛ркорк╛рки рк╡рк┐рк╢рлЗ рккрлВркЫрлЛ.",
                "or": " рморнЛрмдрнЗ рмирм┐рм╢рнНрмЪрм┐рмд рмирнБрм╣рнЗрмБред рмлрм╕рм▓, рм╕рм░рнНрммрм░рм╛рм╣, рммрм░рнНрм╖рм╛ рммрм┐рм╖рнЯрм░рнЗ рмкрмЪрм╛рм░рмирнНрмдрнБред",
                "bn": " ржЖржорж┐ ржирж┐рж╢рзНржЪрж┐ржд ржиржЗред ржжржпрж╝рж╛ ржХрж░рзЗ ржлрж╕рж▓, рж╕рж╛рж░, ржмрж╛ ржЖржмрж╣рж╛ржУржпрж╝рж╛ рж╕ржорзНржкрж░рзНржХрзЗ ржЬрж┐ржЬрзНржЮрж╛рж╕рж╛ ржХрж░рзБржиред",
                "as": " ржоржЗ ржирж┐рж╢рзНржЪрж┐ржд ржирж╣ржпрж╝ред ржЕржирзБржЧрзНрз░рж╣ ржХрз░рж┐ ржЦрзЗрждрж┐, рж╕рж╛рз░ ржмрж╛ ржмрждрз░рз░ ржмрж┐рж╖ржпрж╝рзЗ рж╕рзЛржзржХред"
                }.get(lang, "ЁЯдФ I'm not sure.")
    except Exception as e:
        return f"тЪая╕П Error in chatbot response: {str(e)}"
